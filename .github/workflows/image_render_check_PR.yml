name: 🚀 Pull Request
on:
  pull_request: {}

permissions:
  actions: write
  contents: read

jobs:
  lint:
    name: ⬣ Deps Check
    runs-on: ubuntu-latest
    steps:
      - name: 🛑 Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.11.0

      - name: ⬇️ Checkout repo
        uses: actions/checkout@v3

      - name: Install native deps
        run: sudo apt-get install build-essential libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev

      - name: ⎔ Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: 📥 Download deps
        uses: bahmutov/npm-install@v1
        with:
          useLockFile: true

      - name: 🔬 Lint
        run: npm run prettier:check

  renderTest:
    name: ⬣ Rendering Test
    runs-on: ubuntu-latest
    steps:
      - name: 🛑 Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.11.0

      - name: ⬇️ Checkout repo
        uses: actions/checkout@v3
        
      - name: Install native deps
        run: sudo apt-get install build-essential libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev

      - name: ⎔ Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: 📥 Download deps
        uses: bahmutov/npm-install@v1
        with:
          useLockFile: true
      
      - name: Run Server and Save Image
        run: |
          export Client_ID=${{secrets.SPOTIFY_CLIENT_ID}} Client_Secret=${{secrets.SPOTIFY_CLIENT_SECRET}}
          npm start &
          sleep 5 &&
          curl http://localhost:3000/api?id=05iALOptaNoV3EmXnxz1IJ&color=A0C3D2 > output.png &&
          ls
      
#       - name: Wget Local Render Image
#         run: curl http://localhost:3000/api?id=05iALOptaNoV3EmXnxz1IJ&color=A0C3D2 > output.png
      
      - name: Upload a picture
        uses: devicons/public-upload-to-imgur@v2.2.2
        id: imgur_step
        with:
          path: ./output.png 
          client_id: ${{secrets.IMGUR_CLIENT_ID}}

      - name: Comment on the PR about the result
        uses: github-actions-up-and-running/pr-comment@v1.0.1  # you can use any action that you want. This is only an example
        env:
          # recall that this action returns a JSON.stringified array
          IMG_URL: ${{ fromJSON(steps.imgur_step.outputs.imgur_urls)[0] }}  # get the output of the step above using its id
          MESSAGE: |
            Preview of Alchemy Song on Test Build:
            ![Image]({0}) # markdown syntax for displaying a picture
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          message: ${{format(env.MESSAGE, env.IMG_URL)}}  # add the url into the string
